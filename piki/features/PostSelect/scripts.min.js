var PostSelect,$body;!function(e){PostSelect={init:function(){($body=e("body")).on("click",'button[data-action="post-select-open"]',function(e){e.preventDefault(),PostSelect.bindSelect(this)})},getButtonData:function(t){t.$=t.$||e(t);var s=t.$.data("PostSelect");return void 0!==s?s:s={_:t,$:t.$,$target:t.$.siblings('input[data-group="post-select"]'),postTypes:t.$.data("post-types"),parentID:t.$.data("post-parent")}},bindSelect:function(e){var t=this.getButtonData(e);PostSelect.open(t)},selectItems:function(t){console.info("data.$.data()"),console.log(t.$.data());var s=e(".posts-field-selection li.selected");if(!s.length)return!0;s.each(function(){this.$=this.$||e(this),console.info("data.selectbox"),console.log(t.selectbox),t.selectbox.$.Modal("close");var s=this.$.data("id"),o=this.$.children("strong").text();PostSelect.createItemList(t,s,o)})},open:function(t){Loader(),e.ajax({method:"POST",url:ajaxurl,data:{action:"post_select_list",post_types:t.postTypes,parent_id:t.parentID,actual_ids:t.$target.val()}}).done(function(e){if(Loader("close"),"object"==typeof e){var s;s=void 0!==e.items?"Nenhum post disponível para seleção.":e.error_message,Message.open(s)}else PostSelect.createModal(t,e)}).fail(function(e,t){Loader("close"),Message.open("Problema ao recuperar Form: "+e.responseText)})},createModal:function(t,s){var o=e(".piki-modal.post-select");o.length&&o.remove(),t.selectbox={$:e(s).appendTo("body")},t.selectbox.$list=t.selectbox.$.children(".posts-list").first(),t.selectbox.$footer=t.selectbox.$.children("footer").first(),PostSelect.initFilters(t),PostSelect.checkPager(t),t.selectbox.$.Modal({className:"post-select wp-core-ui",width:"800",height:"600",keepVisible:!0,title:"Selecionar post"}),t.$.data("PostSelect",t)},initFilters:function(e){e.selectbox.$header=e.selectbox.$.children("header"),e.selectbox.$header.length&&(e.selectbox.filters={$:e.selectbox.$header,$trigger:e.selectbox.$header.children('button[data-action="do-filter"]')},e.selectbox.filters.$fields=e.selectbox.filters.$.children(".linha-field").find("input,select"),e.selectbox.filters.lastFilter=e.selectbox.filters.$.find("input,select").serialize(),e.selectbox.filters.$.find("input#nome").off("keypress.psbind").on("keypress.psbind",function(t){13==t.keyCode&&PostSelect.bindFilterSend(e)}),e.selectbox.filters.$trigger.off("click.psbind").on("click.psbind",function(t){event.preventDefault(),PostSelect.bindFilterSend(e)}))},bindFilterSend:function(e){var t=e.selectbox.filters.$.find("input,select").serialize();t!==e.selectbox.filters.lastFilter&&(e.selectbox.filters.lastFilter=t,PostSelect.requireItems(e,!1,!0))},getFilters:function(t){var s={};return t.selectbox.filters.$fields.each(function(){this.$=this.$||e(this),s[this.$.attr("name")]=this.$.val()}),s},clearFilters:function(e){e.selectbox.filters.$fields.val(""),e.selectbox.filters.lastFilter=e.selectbox.filters.$fields.serialize(),PostSelect.requireItems(e,!1,!0)},checkPager:function(t){void 0!==t.selectbox.$pager&&t.selectbox.$pager.remove();var s=t.selectbox.$.data("total-items"),o=t.selectbox.$.data("items-per-page");if(!(s<=o)){for(var l=[],i=1;i<=s;i++)l.push(i);var a="_"+Math.random().toString(36).substr(2,9);t.selectbox.$pager=e('<div id="'+a+'" class="tablenav-pages pager"></div>').appendTo(t.selectbox.$footer),t.selectbox.$pager.pagination({dataSource:l,totalNumber:s,pageSize:o,pageRange:1,prevText:"‹",nextText:"›",triggerPagingOnInit:!1,callback:function(e,s){PostSelect.requireItems(t,s.pageNumber)}})}},requireItems:function(t,s,o){e.ajax({method:"POST",url:ajaxurl,data:{action:"piki_field_ajax",field_type:"posts_inside",field_action:"get_items",filters:PostSelect.getFilters(t),page:s,action:"post_select_list",post_types:t.postTypes,parent_id:t.parentID,actual_ids:t.$target.val()}}).done(function(e){t.selectbox.$.data("total-items",e.total_items),void 0!==o&&PostSelect.checkPager(t),e.content?s<2?t.selectbox.$list.html(e.content).show():t.selectbox.$list.stop(!0,!0).fadeOut(100,function(){t.selectbox.$list.html(e.content).fadeIn(200,function(){t.selectbox.$list.scrollTo(0)})}):Message.open({classname:"alert",title:"Ops!",message:"Nenhum resultado para estes filtros.",buttons:[{classname:"button button-primary add",label:"Limpar filtros",callback:function(){PostSelect.clearFilters(t)}},{classname:"button",label:"Fechar"}]})}).fail(function(t,s){e.fn.pikiLoader("close"),Message.open("Problema ao recuperar ítems: "+s)})}},e(function(){PostSelect.init()})}(jQuery);