!function($){function get_default_ini_crop_coords(t){var i=.9,e=Math.round(t.croparea.width*i),r=Math.round(e/t.ratio);r>t.croparea.height&&(r=Math.round(t.croparea.height*i),e=Math.round(r*t.ratio));var o=Math.round((t.croparea.width-e)/2),a=Math.round((t.croparea.height-r)/2);return[o,a,o+e,a+r]}function get_restored_ini_crop_coords(t){if(""==t.crop.coords.x.val())return!1;var i=t.crop.coords.x.val(),e=t.crop.coords.y.val(),r=t.crop.coords.width.val(),o=t.crop.coords.height.val();return void 0!=i?(show_x=Math.round(i*t.crop.croparea.width/t.crop.target.width),show_y=Math.round(e*t.crop.croparea.height/t.crop.target.height),show_w=Math.round(r*t.crop.croparea.width/t.crop.target.width),show_h=Math.round(o*t.crop.croparea.height/t.crop.target.height),[show_x,show_y,show_w+show_x,show_h+show_y]):!1}window.startImageWP=function(){$(".field-item > div.ftype-imagewp").imageWpField()},pikiforms_init_methods.push("window.startImageWP"),$(function(){"function"==typeof window.fieldset_field_set_callback&&window.fieldset_field_set_callback(window.startImageWP),window.startImageWP()}),$.fn.imageWpField=function(method){var pluginArgs=arguments;return this.each(function(){var field=this,$this=$(this);this.configure=function(){if(this.target=$("input.imagews-ids",$this).first(),this.select=$("input.imagewp-select-button",$this).first(),this.edit=$("input.imagewp-edit-button",$this).first(),this.remove=$("input.imagewp-remove-button",$this).first(),this.label=$("input.imagewp-upload-label",$this).first().val(),this.thumbs=$("div.imagewp-media-thumbs",$this).first(),this.status=$("div.imagewp-media-status",$this).first(),this.multiple=void 0!=$this.attr("--multiple")&&"on"==$this.attr("--multiple"),this.croppable=void 0!=$this.attr("--crop")&&"on"==$this.attr("--crop"),this.croppable){var t=$this.attr("--crop-ratio").split("x");t=parseInt(t[0])/parseInt(t[1]),this.crop={wrapper:$(".imagewp-media-croparea",$this).first(),coords:{x:$("input.coord-x",$this).first(),y:$("input.coord-y",$this).first(),width:$("input.coord-width",$this).first(),height:$("input.coord-height",$this).first()},ratio:t};var i=$("img.imagewp-croparea",$this).first();i.length&&(this.crop.target={image:i,width:i.attr("width"),height:i.attr("height")})}else this.thumbs.on("mousedown","a.preview",function(t){var i=$(this);return i.is(".fancy")||i.addClass(".fancy").fancybox(),!0}),this.thumbs.on("click","a.remove",function(t){t.preventDefault(),field.removeGalleryItem($(this))}),this.multiple&&(this.thumbs.sortable({items:"div.thumbnail",stop:function(t,i){field.alignValues()}}),this.thumbs.disableSelection());this.wpmedia=wp.media.frames.customHeader=wp.media({title:field.select.val(),library:{type:"image"},button:{text:field.select.val()},multiple:void 0!=$this.attr("--multiple")&&"on"==$this.attr("--multiple")?!0:!1}),this.wpmedia.on("select",function(){var t=field.wpmedia.state().get("selection");field.returnFile(t)}),this.select.on("click",function(t){t.preventDefault(),field.wpmedia.open()}),this.edit.on("click",function(t){t.preventDefault(),field.wpmedia.open()}),this.remove.on("click",function(t){t.preventDefault(),field.removeValues(),field.remove.hide(),field.edit.hide(),field.select.show()}),this.croppable&&void 0!=this.crop.target&&this.startCrop(),this.ready=!0},this.alignValues=function(){var t=[];this.thumbs.children().each(function(){t.push($(this).attr("rel"))}),this.target.val(t.join(","))},this.returnFile=function(t){this.remove.show(),this.multiple?(field.edit.hide(),field.select.show()):(this.removeValues(),field.edit.show(),field.select.hide());var i=field.target.val();i=""===i?Array():i.split(","),t.map(function(t){if(t=t.toJSON(),i.push(t.id),field.crop){var e=$('<img src="'+t.sizes.full.url+'" class="imagewp-croparea" width="'+t.width+'" height="'+t.height+'" />').appendTo(field.crop.wrapper).hide();field.crop.target={image:e,width:t.width,height:t.height},field.crop.coords.x.val(""),field.crop.coords.y.val(""),field.crop.coords.width.val(""),field.crop.coords.height.val(""),field.crop.wrapper.show(),field.startCrop()}else{var r=void 0===t.sizes.thumbnail?t.sizes.full.url:t.sizes.thumbnail.url;$newthumb=$('<div class="thumbnail" rel="'+t.id+'"></div>'),$newthumb.html('<img src="'+r+'" alt="'+t.alt+'" /><a href="'+t.sizes.full.url+'" rel="'+t.id+'" target="_blank" class="action preview">Ampliar imagem</a><a rel="'+t.id+'" class="action remove" title="Remover">Remover imagem</a>'),field.thumbs.stop(!0,!0).show(),$newthumb.hide().prependTo(field.thumbs).fadeIn(400)}}),field.target.val(i.join(","))},this.startCrop=function(){this.crop.target.image.hide();var t=$this.parents(".linha-field.ftype-imagewp"),i=Math.round(.9*t.outerWidth());this.crop.croparea={width:i,height:Math.round(i*this.crop.target.height/this.crop.target.width)},this.crop.target.image.width(this.crop.croparea.width),this.crop.target.image.height(this.crop.croparea.height),this.crop.target.image.show(),coords_ini=get_restored_ini_crop_coords(this),0==coords_ini&&(coords_ini=get_default_ini_crop_coords(this.crop)),this.cropAPI=$.Jcrop(this.crop.target.image,{bgFade:!0,bgOpacity:.2,aspectRatio:this.crop.ratio,minSize:[40,40],allowSelect:!1,setSelect:[0,0,1,1],bgColor:"black",onSelect:function(t){field.showCoords(t)},onChange:function(t){field.showCoords(t)}}),this.cropAPI.animateTo(coords_ini)},this.showCoords=function(t){var i=this.crop.target.width*t.x/this.crop.croparea.width,e=this.crop.target.height*t.y/this.crop.croparea.height,r=this.crop.target.width*t.w/this.crop.croparea.width,o=this.crop.target.height*t.h/this.crop.croparea.height;this.crop.coords.x.val(Math.round(i)),this.crop.coords.y.val(Math.round(e)),this.crop.coords.width.val(Math.round(r)),this.crop.coords.height.val(Math.round(o))},this.removeValues=function(){this.crop&&(this.crop.wrapper.stop(!0,!0).hide().html(""),this.crop.coords.x.val(""),this.crop.coords.y.val(""),this.crop.coords.width.val(""),this.crop.coords.height.val("")),this.thumbs.length&&this.thumbs.stop(!0,!0).hide().html(""),this.target.val("")},this.removeGalleryItem=function(t){var i=t.attr("rel"),e=this.target.val().split(","),r=Array();$.each(e,function(t,e){e!=i&&r.push(e)}),this.target.val(r.join(",")),t.parent().fadeOut(250,function(){$(this).remove()})};var toCall;if(void 0==(toCall=eval("this."+method))){if(this.ready)return;this.configure.apply(this,pluginArgs)}else toCall.apply(this,Array.prototype.slice.call(pluginArgs,1))})}}(jQuery);