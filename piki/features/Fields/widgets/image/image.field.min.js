PikiFields.add("window.startImage");var imageField;!function(e){window.startImage=function(){e('input[type="file"].ftype-image').each(function(){imageField.configure(this)})},imageField={configure:function(i){i.$=i.$||e(i);a=i.$.data("imageField");if(void 0===a){var a,t=i.$.parents("div.ftype-image.item-image").first();if((a={_:i,$:i.$,wrapper:t,$form:i.$.parents("form").first(),$fake:e('<div class="jcuston-image-holder"></div>'),maxsize:i.$.data("max-size"),maxsizeLabel:i.$.data("max-size-label"),title:i.$.attr("title"),isMultiple:t.hasClass("multiple")}).$fake.insertAfter(a.$),a.$.appendTo(a.$fake),void 0!==a.title&&(a.$title=e("<strong>"+a.title+"</strong>").appendTo(a.$fake)),a.$.data("imageField",a),a.isMultiple)a.$wrapImages=e(".wrap-images",a.$main).first(),a.$rows=a.$wrapImages.children(".row-image"),a.$rows.first().remove(),a.maxItems=a.wrapper.data("max-items"),a.modelItem=a.$rows.first().clone().removeClass("model"),a.modelField=a.$.clone(),a.$actualField=a.$,imageField.varifyLimit(a)&&(a.$fake.addClass("disabled"),a.$actualField.prop("disabled",!0)),a.$wrapImages.on("click",".delete",function(i){i.preventDefault(),this.$=this.$||e(this);var t=this.$.parent(".row-image");imageField.checkDeleteImage(a,t)});else if(a.$address=e("input.address",t).first(),a.file_id=e(".file-id",t).first(),a.fullsize=e(".fullsize",t).first(),a.thumbnail=e(".thumbnail",t).first(),a.token=e(".unique-id",t).first().val(),a.cropbox=e(".cropbox",t).first()||!1,a.previewbox=e(".previewbox",t).first()||!1,a.preview={width:i.$.data("preview-width"),height:i.$.data("preview-height")},a.cropbox.length){if(a.croparea=e(".croparea",t).first(),a.$image=e("img",a.croparea).first(),a.$cropinfo=e(".cropinfo",t).first(),a.cropinfo=!1,a.controls=e(".controls",t).first(),a.delete=e("button.delete",a.controls).first(),a.$image.length){var r={viewport:{width:a.preview.width,height:a.preview.height},update:function(e){a.$cropinfo.val(JSON.stringify(e)),a.$.trigger("update",[a,e])}};a.cropinfo=""!==a.$cropinfo.val()&&jQuery.parseJSON(a.$cropinfo.val()),a.cropinfo&&(r.points=a.cropinfo.points),a.croparea.imagesLoaded(function(){a.$image.croppie(r);a.controls.slideDown(100)})}a.delete.on("click",function(e){imageField.checkDeleteImage(a,a.wrapper)})}a.wrapper.on("change",'input[type="file"]',function(){imageField.fieldChanged(a)}),a.$.bind("reset",function(){imageField.reset(a)})}},duplicateField:function(e){var i=e.$actualField.css("z-index");e.$fake.children("input").hide(),e.$actualField=e.modelField.clone().css("z-index",i+2).val("").attr("id",imageField.uniqueID()).prependTo(e.$fake).prop("disabled",!1).show(),e.$fake.removeClass("disabled")},uniqueID:function(){return"_"+Math.random().toString(36).substr(2,9)},addNewRow:function(e){var i=new FileReader;i.onload=function(i){if(i.total>e.maxsize)Message.open("A imagem deve ter no máximo "+e.maxsizeLabel);else{var a=e.$.val().split("\\").join("/").replace("\\","/").split("/").pop(),t=e.modelItem.clone().hide();t.children(".image-box").html('<img src="'+i.target.result+'">'),t.children(".filename").html("<strong>"+a+"</strong>"),t.data("targetID",e.$actualField.attr("id"));var r=t.children(".percent"),l=t.children(".progress-bar"),o=l.children("span"),n=t.children(".delete"),s=0;t.appendTo(e.$wrapImages).slideDown(function(){var e=setInterval(function(){s+=1,o.css("width",s+"%"),r.text(s+"%"),s>=100&&(l.addClass("loaded"),r.hide(),n.show(),clearInterval(e))},5)}),imageField.varifyLimit(e)?(e.$fake.children("input").hide(),e.$fake.addClass("disabled")):imageField.duplicateField(e)}},i.readAsDataURL(e.$actualField.get(0).files[0])},checkDeleteImage:function(e,i){var a=i.find("input.file-id");if(a.length&&""!==a.val()){var t={action:"field_image_delete",post_id:e.$form.find("input#item_id").val(),field_key:e.$.parents(".linha-field").first().data("machine-name"),nonce:i.find("input.file-nonce").val(),file_id:i.find("input.file-id").val(),is_multiple:e.isMultiple};Message.open({title:!1,message:"<strong>Tem certeza de que deseja excluir essa imagem?</strong>",buttons:[{label:"Excluir imagem",classname:"button",callback:function(){imageField.deleteServerImage(e,t,i)}},{label:"Cancelar",classname:"link"}]})}else if(e.isMultiple){var r=i.data("targetID");e.$fake.children("input#"+r).remove(),imageField.duplicateField(e),imageField.deleteRow(e,i)}else e.$.val(""),imageField.reset(e)},deleteServerImage:function(i,a,t){e.fn.pikiLoader("all"),e.ajax({type:"POST",url:Piki.ajaxurl,dataType:"json",data:a}).done(function(a){e.fn.pikiLoader("close"),"error"==a.status?Message.open({message:"<em>"+a.error_message+"</em>",classname:"error"}):i.isMultiple?imageField.deleteRow(i,t):(i.$.val(""),imageField.reset(i))}).error(function(i,a){e.fn.pikiLoader("close"),Message.open({message:"<em>Erro na requisição</em>",classname:"error"})})},deleteRow:function(e,i){i.addClass("removed").slideUp(250,function(){i.remove()}),e.$actualField.prop("disabled",!1).show(),e.$fake.removeClass("disabled")},varifyLimit:function(e){return e.maxItems<=e.$wrapImages.children(".row-image").not(".removed").length},fieldChanged:function(i){""!=i.$.val()&&(i.isMultiple?imageField.addNewRow(i):imageField.reset(i,function(){var a=new FileReader;a.onload=function(a){if(a.total>i.maxsize)Message.open("A imagem deve ter no máximo "+i.maxsizeLabel);else{var t=i.$.val().split("\\").join("/").replace("\\","/").split("/").pop();if(i.$address.val(t),i.$image=e('<img src="'+a.target.result+'">'),i.cropbox.length){i.$image.appendTo(i.croparea);i.$image.croppie({viewport:{width:i.preview.width,height:i.preview.height},update:function(e){i.$cropinfo.val(JSON.stringify(e)),i.$.trigger("update",[i,e])}});i.controls.slideDown()}else i.$image.appendTo(i.previewbox);i.$.trigger("afterChange",i)}},a.readAsDataURL(i._.files[0])}))},receiveImage:function(i,a){if(i.$image=e('<img src="'+a.fullsize+'">'),i.cropbox){i.$image.appendTo(i.cropbox);i.$image.croppie({viewport:{width:i.preview.width,height:i.preview.height}})}else i.$thumb=e('<div class="thumbnail"></div>').appendTo(i.$wrapper),$image.appendTo($thumb)},deleteConfirm:function(i){var a=e(".confirm-box",i.wrapper);a.length||((a=e('<div class="confirm-box"></div>')).html('<span>Deletar foto?</span><a class="no">Não</a><a class="yes">Sim</a>'),a.appendTo(i.wrapper)),a.find(".no").on("click",function(){e(this).parent().hide()}),a.find(".yes").on("click",function(){imageField.doDelete(i)}),a.show()},doDelete:function(i){e.ajax({type:"POST",url:Piki.blogurl+"/campo-imagem/remove/"+i.file_id.val(),dataType:"text",data:{token:i.token}}).done(function(e){"error"==e.status?alert(e.error_message):imageField.reset(i)}).error(function(e,i){console.info("erro1"),console.log(e),console.info("err2"),console.log(i)}),clear_file_field(i.$)},reset:function(e,i){!1===e.isMultiple?(e.$address.val(""),e.file_id.val(""),e.fullsize.val(""),e.cropbox.length?(e.controls.hide(),e.croparea.hide(),e.$cropinfo.val(""),e.croparea.html("").show(),e.$image.length&&(e.$image.croppie("destroy").remove(),e.$image=!1)):e.wrapper.find("div.thumbnail").remove()):(e.$wrapImages.html(""),e.$previewbox.html(""),e.$fake.children("input:not(:last)").remove(),e.$actualField=e.$fake.children("input").first(),e.$actualField.show()),e.$.trigger("update",[e]),void 0!==i&&i(e)}},window.imageField_receive_image=function(i){e("#image-field-fake-form").remove();var a=e.parseJSON(i);if("error"==a.status)Message.open(a.message);else{var t=e('input[value="'+a.token+'"]').parents(".ftype-image.item-image").find('input[type="file"]').data("imageField");imageField.receiveImage(t,a)}},window.imageField_error=function(e,i){alert(i)}}(jQuery);