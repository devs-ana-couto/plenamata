PikiFields.add("window.startPostsField");var PostField;!function(e){window.startPostsField=function(){e(".field-posts-wrapper").each(function(){PostField.configure(this)})},PostField={configure:function(t){t.$=t.$||e(t);var i=t.$.data("PostField");if(void 0!==i)return!0;var o=e("body");i={_:t,$:t.$,target:t.$.children("input.ftype-posts-inside"),parentID:t.$.parents("form").first().find("input#post_ID").val(),parentType:t.$.parents("form").first().find("input#post_type").val(),form_key:e(".field-form-key",t.$).first().val(),name:e(".field-name",t.$).first().val(),items:e(".posts-list",t.$).first(),itemModel:e(".posts-list .model",t.$),header:t.$.children("header"),footer:t.$.children("footer"),insert:e('button[data-action="insert"]',t.$),select:e('button[data-action="select"]',t.$),current_item:!1,modal:!1},t.$.data("PostField",i),i.insert.off("click").on("click",function(e){e.preventDefault(),PostField.openModalForm(i)}),o.off("click").on("click","button[data-action]",function(t){t.preventDefault(),this.$=this.$||e(this);var i=this.$.parents(".field-posts-wrapper").first().data("PostField"),o=this.$.data("action"),s=this.$.parents(".post-item").first();"edit-post-inside"===o?PostField.openModalForm(i,s):"remove-post-inside"===o?PostField.removeItem(i,s):"delete-post-inside"===o&&PostField.deleteItem(i,s)}),i.items.sortable({update:function(e,t){PostField.setOrder(i)}}),PostField.Select.init(i),PostField.checkStructure(i)},setOrder:function(t){var i=t.items.children("li.post-item");if(i.length){var o=[];i.each(function(){this.$=this.$||e(this),o.push(this.$.children("input").val())}),t.target.val(o.join(","))}},toggleSelectionItem:function(t,i){i.$.hasClass("selected")?i.$.removeClass("selected"):i.$.addClass("selected");var o=e(".piki-modal.postsfield .posts-list li.selected"),s=e('.piki-modal.postsfield button[data-action="do-select"]');o.length?s.prop("disabled",!1):s.prop("disabled",!0)},checkStructure:function(e){e.items.children("li").length>1?(e.footer.show(),e.items.show()):(e.footer.hide(),e.items.hide())},openModalForm:function(t,i){var o={action:"piki_field_ajax",field_type:"posts_inside",field_action:"get_post_form",post_parent:t.parentID,form_key:t.form_key,field_name:t.name};void 0!==i&&i.length?(o.post_id=e("input.item-id",i).val(),t.current_item=i):(o.post_id=!1,t.current_item=!1),e.fn.pikiLoader(),e.ajax({method:"POST",url:ajaxurl,data:o}).done(function(i){if(e.fn.pikiLoader("close"),"object"==typeof i)Message.open(i.error_message),console.log("response:"),console.log(i);else{var o=e("#pikiform-postfield-modal");o.length&&o.remove();PostField.responseForm(t,i,function(i,o){if(t.current_item)t.current_item.slideUp(200,function(){this.$=this.$||e(this),e(".title",t.current_item).html(o.post.post_title),this.$.slideDown(300)});else{PostField.insertValue(t,o.post.ID);var s=t.items.children(".model").clone();e(".title",s).html(o.post.post_title),e("input.item-id",s).val(o.post.ID),s.removeClass("model").addClass("post-item").hide().appendTo(t.items).slideDown(300)}PostField.checkStructure(t),t.modal.Modal("close")})}}).fail(function(t,i){e.fn.pikiLoader("close"),Message.open("Problema ao recuperar Form: "+i)})},insertValue:function(e,t){var i=e.target.val().split(",");i.push(t),e.target.val(i)},removeValue:function(e,t){var i=e.target.val();if(""!==i){var o=i.split(",").filter(function(e,i,o){return parseInt(e)!==parseInt(t)}).join(",");e.target.val(o)}},responseForm:function(t,i,o){var s=e("#pikiform-postfield-modal");s.length&&s.remove();var l=e("<div>"+i+"</div>");t.modal=l.children("#pikiform-postfield-modal"),t.modal.children(".form-header").hide(),t.modal.appendTo("body"),t.modal.children("form").PikiForm({finishCallback:o}),t.modal.Modal({className:"postsfield wp-core-ui",width:"800",height:"600",title:t.insert.first().attr("title"),onClosed:function(e){TextareaField.removeEditors(e.modal)}})},Select:{init:function(t){t.select.off("click.psbind").on("click.psbind",function(e){e.preventDefault(),PostField.Select.open(t)}),_body.off("click.tgsel").on("click.tgsel",".posts-field-selection li",function(){this.$=this.$||e(this);var t=this.$.parents(".posts-field-selection").data("field-name"),i=e('div.ftype-posts-inside[data-machine-name="'+t+'"] .field-posts-wrapper').data("PostField");PostField.toggleSelectionItem(i,this)}),_body.off("click.tgsel2").on("click.tgsel2",'.posts-field-selection button[data-action="do-select"]',function(){this.$=this.$||e(this);var t=this.$.data("field-name"),i=e('div.ftype-posts-inside[data-machine-name="'+t+'"] .field-posts-wrapper').data("PostField");PostField.Select.selectItems(i)})},selectItems:function(t){console.info("data.$.data()"),console.log(t.$.data());var i=e(".posts-field-selection li.selected");if(!i.length)return!0;i.each(function(){this.$=this.$||e(this),console.info("data.selectbox"),console.log(t.selectbox),t.selectbox.$.Modal("close");var i=this.$.data("id"),o=this.$.children("strong").text();PostField.createItemList(t,i,o)})},open:function(t){e.fn.pikiLoader(),e.ajax({method:"POST",url:ajaxurl,data:{action:"piki_field_ajax",field_type:"posts_inside",field_action:"get_selection",form_key:t.parentType,parent_id:t.parentID,field_name:t.name,actual_ids:t.target.val()}}).done(function(i){if(e.fn.pikiLoader("close"),"object"==typeof i){var o;o=void 0!==i.items?"Nenhum post disponível para seleção.":i.error_message,Message.open(o)}else PostField.Select.createModal(t,i)}).fail(function(t,i){e.fn.pikiLoader("close"),Message.open("Problema ao recuperar Form: "+t.responseText)})},createModal:function(t,i){var o=e(".piki-modal.postsfield");o.length&&o.remove(),t.selectbox={$:e(i).appendTo("body")},t.selectbox.$list=t.selectbox.$.children(".posts-list").first(),t.selectbox.$footer=t.selectbox.$.children("footer").first(),PostField.Select.initFilters(t),PostField.Select.checkPager(t),t.selectbox.$.Modal({className:"postsfield wp-core-ui",width:"800",height:"600",keepVisible:!0,title:t.select.first().attr("title")}),t.$.data("PostField",t)},initFilters:function(e){e.selectbox.$header=e.selectbox.$.children("header"),e.selectbox.$header.length&&(e.selectbox.filters={$:e.selectbox.$header,$trigger:e.selectbox.$header.children('button[data-action="do-filter"]')},e.selectbox.filters.$fields=e.selectbox.filters.$.children(".linha-field").find("input,select"),e.selectbox.filters.lastFilter=e.selectbox.filters.$.find("input,select").serialize(),e.selectbox.filters.$.find("input#nome").off("keypress.psbind").on("keypress.psbind",function(t){13==t.keyCode&&PostField.Select.bindFilterSend(e)}),e.selectbox.filters.$trigger.off("click.psbind").on("click.psbind",function(t){event.preventDefault(),PostField.Select.bindFilterSend(e)}))},bindFilterSend:function(e){var t=e.selectbox.filters.$.find("input,select").serialize();t!==e.selectbox.filters.lastFilter&&(e.selectbox.filters.lastFilter=t,PostField.Select.requireItems(e,!1,!0))},getFilters:function(t){var i={};return t.selectbox.filters.$fields.each(function(){this.$=this.$||e(this),i[this.$.attr("name")]=this.$.val()}),i},clearFilters:function(e){e.selectbox.filters.$fields.val(""),e.selectbox.filters.lastFilter=e.selectbox.filters.$fields.serialize(),PostField.Select.requireItems(e,!1,!0)},checkPager:function(t){void 0!==t.selectbox.$pager&&t.selectbox.$pager.remove();var i=t.selectbox.$.data("total-items"),o=t.selectbox.$.data("items-per-page");if(!(i<=o)){for(var s=[],l=1;l<=i;l++)s.push(l);var a="_"+Math.random().toString(36).substr(2,9);t.selectbox.$pager=e('<div id="'+a+'" class="tablenav-pages pager"></div>').appendTo(t.selectbox.$footer),t.selectbox.$pager.pagination({dataSource:s,totalNumber:i,pageSize:o,pageRange:1,prevText:"‹",nextText:"›",triggerPagingOnInit:!1,callback:function(e,i){PostField.Select.requireItems(t,i.pageNumber)}})}},requireItems:function(t,i,o){e.ajax({method:"POST",url:ajaxurl,data:{action:"piki_field_ajax",field_type:"posts_inside",field_action:"get_items",form_key:t.parentType,field_name:t.name,actual_ids:t.target.val(),filters:PostField.Select.getFilters(t),page:i}}).done(function(e){t.selectbox.$.data("total-items",e.total_items),void 0!==o&&PostField.Select.checkPager(t),e.content?i<2?t.selectbox.$list.html(e.content).show():t.selectbox.$list.stop(!0,!0).fadeOut(100,function(){t.selectbox.$list.html(e.content).fadeIn(200,function(){t.selectbox.$list.scrollTo(0)})}):Message.open({classname:"alert",title:"Ops!",message:"Nenhum resultado para estes filtros.",buttons:[{classname:"button button-primary add",label:"Limpar filtros",callback:function(){PostField.Select.clearFilters(t)}},{classname:"button",label:"Fechar"}]})}).fail(function(t,i){e.fn.pikiLoader("close"),Message.open("Problema ao recuperar ítems: "+i)})}},removeEditors:function(){void 0!==tinymce&&($editors_wrapers=e(".piki-modal .ftype-textarea-editor-wrapper"),$editors_wrapers.length&&$editors_wrapers.each(function(){}))},removeItem:function(e,t){PostField.removeItemFromList(e,t)},deleteItem:function(e,t){Message.open({title:"Apagar ítem",message:"Deseja mesmo apagar este ítem do sistema? <br>Esta operação não poderá ser desfeita futuramente.",classname:"postsfield-warning",buttons:[{label:"Não",classname:"button button-primary button-large"},{label:"Sim",classname:"button button-primary button-large danger",callback:function(){PostField.doDdeleteItem(e,t)}}]})},doDdeleteItem:function(t,i){e.fn.pikiLoader();var o=e("input.item-id",i).val(),s={action:"piki_field_ajax",field_type:"posts_inside",field_action:"remove_item",field_name:t.target.data("machine-name"),parent_id:t.parentID,post_id:o};e.post(ajaxurl,s,function(o){e.fn.pikiLoader("close"),"object"!=typeof o?Message.open({title:"Ops!",message:o}):"error"==o.status?Message.open({title:"Ops!",message:o.error_message}):PostField.removeItemFromList(t,i)})},createItemList:function(t,i,o){PostField.insertValue(t,i);var s=t.itemModel.clone();e("input.item-id",s).val(i),e(".title",s).html(o),s.removeClass("model").addClass("post-item").hide().appendTo(t.items).slideDown(300),PostField.checkStructure(t)},removeItemFromList:function(t,i){var o=i.find("input.item-id").val();PostField.removeValue(t,o),i.slideUp("300",function(){e(this).remove(),PostField.checkStructure(t)})}}}(jQuery);