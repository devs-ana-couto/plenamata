PikiFields.add("window.startFieldset"),function($){var _body=$("body");window.startFieldset=function(){Fieldset.init()};var Fieldset={init:function(){$(".linha-field.ftype-fieldset").each(function(){Fieldset.configure(this)})},configure:function(e){e.$=e.$||$(e);var t=e.$.data("Fieldset");if(void 0!==t)return t;(t={_:e,$:e.$,field_id:e.$.attr("rel"),isMultiple:e.$.hasClass("multiple"),maximo:void 0===e.$.attr("--maximo")?0:parseInt(e.$.attr("--maximo")),minimo:void 0===e.$.attr("--minimo")?1:parseInt(e.$.attr("--minimo")),abertos:void 0===e.$.attr("--abertos")?0:parseInt(e.$.attr("--abertos")),$form:e.$.parents("form").first(),$rows:e.$.children(".field-item").children(".fieldset-group-fields"),metabox_id:e.$.data("metabox-id"),deleteAlert:e.$.data("delete-alert"),noLabels:void 0!==e.$.data("no-labels"),moving:!1,add_button:!1}).$post_id=$('input[name="post_ID"]',t.$form),t.$item_id=$('input[name="item_id"]',t.$form),t.form_id=$('input[name="form_id"]',t.$form).val(),t.form_key=$('input[name="form_key"]',t.$form).val(),t.form_style=$('input[name="form_style"]',t.$form).val(),t.form_state=$('input[name="form_state"]',t.$form).val(),t.addLabel=void 0===t.$rows.data("add-label")?"Adicionar":t.$rows.data("add-label"),0===t.minimo&&(t.minimo=1),e.$.data("Fieldset",t),t.isMultiple&&this.makeMultiple(t)},makeMultiple:function(e){Fieldset.actualizeRows(e)},actualizeRows:function(e){e.$rows=e.$.children(".field-item").children(".fieldset-group-fields").not(".deleted"),e.total_rows=e.$rows.length,Fieldset.realignIndexes(e),Fieldset.alignButtons(e),e.$.trigger("actualize")},realignIndexes:function(e){e.$rows.each(function(t){var a=e.$rows.eq(t);Fieldset.setRowHeader(e,this,t),a.children("input.weight").val(t),a.find(".linha-field-label label i").text(t+1),a.find("input,select,textarea").each(function(){this.$=this.$||$(this);var e=this.$.attr("id");if(void 0!=e){for(var i=e.split("_"),o=0;o<i.length;o++)if(!isNaN(i[o])){i[o]=t;break}var d=i.join("_");this.$.attr("id",d)}if(void 0!=this.$.attr("name")){for(var r=this.$.attr("name").split("]["),o=0;o<r.length;o++)if(!isNaN(r[o])){r[o]=t;break}var n=r.join("][");this.$.attr("name",n)}var l=a.find('label[for="'+e+'"]');l.length&&l.attr("for",d)})})},alignButtons:function(data){if(data.$rows.length){piki_zebra(data.$rows),0===data.maximo||data.total_rows<data.maximo?data.add_button||(data.add_button=$('<button type="button" class="add-button button"><span>'+data.addLabel+"</span></button>"),data.add_button.data("fieldset",{target:data._}),data.add_button.on("click",function(e){e.preventDefault(),Fieldset.getFieldsetRow(data,this)}),data.add_button.appendTo(data.$)):(data.add_button&&data.add_button.remove(),data.add_button=!1);for(var excludable=data.total_rows>data.minimo,rw=0;rw<data.total_rows;rw++){var $row=data.$rows.eq(rw).data("fieldset",{target:data}),$exclude_button=$row.find(".remove-button");excludable?($exclude_button.bind("click.deleteRow",function(e){e.preventDefault(),data.total_rows<=data.minimo||(data.deleteAlert?eval(data.deleteAlert)(data,this.target):Fieldset.deleteRow(data,this.target))}),$exclude_button.fadeIn(200)):$exclude_button.unbind(".deleteRow").fadeOut(200)}}},getFieldsetRow:function(e,t){t.$=t.$||$(t);var a=!(!e.$post_id.length||""===e.$post_id.val())&&e.$post_id.val();a||(a=!(!e.$item_id.length||""===e.$item_id.val())&&e.$item_id.val());var i={action:"piki_field_ajax",field_type:"fieldset",field_action:"ajax_get_row",form_id:e.form_id,form_key:e.form_key,form_state:e.form_state,form_style:e.form_style,metabox_id:e.metabox_id,fieldset_id:e.field_id,field_index:e.$rows.length},o=$.ajax({url:Piki.ajaxurl+(a?"?post="+a:""),type:"POST",dataType:"json",context:e.$,beforeSend:function(){$.fn.pikiLoader()},data:i});o.done(function(t){if($.fn.pikiLoader("close"),"error"==t.status&&"nofieldsetid"==t.type)e.$form.PikiForm("finish","Ops! Ocorreu um erro.","Por favor, tente novamente mais tarde.<br />Se o erro persistir, entre em contato com o adminstrador do site.");else{var a=$(t.field);a.hide().appendTo(e.$.children(".field-item").first()),PikiFields.call(a.get(0)),Fieldset.actualizeRows(e),a.slideDown(300,function(){if(!e.$form.parents(".piki-modal").length){var t=a.offset().top;PikiForms.setScroll(t)}})}}),o.fail(function(e,t){$.fn.pikiLoader("close"),Message.open({message:e.responseText})})},deleteRow:function(e,t){t.addClass("deleted"),t.slideUp(200,function(){$(this).remove(),Fieldset.actualizeRows(e)})},setRowHeader:function(e,t,a){t.$=t.$||$(t);var i='<button type="button" class="dashicons dashicons-trash remove-button" data-action="delete-row">Remover</button>';e.noLabels?void 0===t.removeButton&&(t.removeButton=$(i).hide().prependTo(t.$).fadeIn(200),t.removeButton.get(0).target=t.$):void 0===t.header?(t.header={wrapper:$("<header></header>").prependTo(t.$)},t.header.title=$("<h3>Item "+(a+1)+"</h3>").appendTo(t.header.wrapper),t.header.title.bind("mouseup",function(){if(!0!==e.moving){var a=$row.$.is(".opened");e.rows.removeClass("opened"),a||t.$.addClass("opened")}}),t.removeButton=$(i).hide().appendTo(t.header.wrapper).fadeIn(200),t.removeButton.get(0).target=t.$):t.header.title.html("Item "+(a+1))}}}(jQuery);