PikiFields.add("PikiCEP.init");var PikiCEP;!function(e){(PikiCEP={$fieldCEP:null,main:function(){e(function(){PikiCEP.init()})},init:function(){var a=e("input.ftype-cep");if(a.length)a.each(function(){PikiCEP.configure(this)});else{var i=e("select.ftype-uf");i.length&&i.each(function(){PikiCEP.checkUFCidade(this)})}},configure:function(a){a.$=a.$||e(a);var i=PikiCEP.getWrapper(a.$);if(i){var d=i.data("PikiCEP");void 0===d&&(d={$main:i,CEP:e("input.ftype-cep",i)||!1,estados:e("select.ftype-uf",i)||!1,cidades:e("select.ftype-cidade",i)||!1,bairro:e("input.bairro",i)||!1,logradouro:e("input.logradouro",i)||!1,preloader:e(".preloader",i)||!1,lastValue:!1,cidadeActual:!1},i.data("PikiCEP",d),d.CEP.length&&(d.CEPWrapper=d.CEP.parents(".linha-field.ftype-cep").first(),d.useDatabase=d.CEP.data("use-database"),d.lasValue=d.CEP.val(),d.useDatabase&&PikiCEP.configureCEP(d)),d.estados.length&&d.cidades.length&&PikiCEP.configureUFCidade(d))}},checkUFCidade:function(a){if(a.$=a.$||e(a),$main=PikiCEP.getWrapper(a.$),$main){var i=e("select.ftype-cidade",$main);if(i.length){var d={$main:$main,estados:a.$,cidades:i,cidadeActual:!1};$main.data("PikiCEP",d),PikiCEP.configureUFCidade(d)}}},getWrapper:function(e){var a=e.parents(".fieldset-group-fields");return a.length||(a=e.parents("form")),!!a.length&&a.first()},configureCEP:function(e){e.CEP.on("blur",function(a){var i=e.CEP.val();9===i.length&&e.lasValue!==i&&(e.lasValue=i,PikiCEP.searchCEPData(e))})},searchCEPData:function(a){e.ajax({type:"POST",url:Piki.ajaxurl,dataType:"JSON",data:{action:"consulta_cep",cep:a.CEP.val()},beforeSend:function(e){a.CEPWrapper.addClass("loading"),e.overrideMimeType("text/plain; charset=utf-8")}}).done(function(e){"not_found"!==e.status&&("success"===e.status?PikiCEP.receiveCepData(a,e):Message.open({title:"Ops!",message:e.error_message,classname:"align-left"}))}).error(function(){a.CEPWrapper.removeClass("loading")})},receiveCepData:function(e,a){if(e.estados.length&&(e.estados.val()!==a.uf?(e.cidadeActual=a.id_cidade,e.estados.val(a.uf).trigger("change")):e.cidades.val(a.id_cidade).trigger("change")),"localidade"==a.tipo)e.bairro.length&&e.bairro.val(""),e.logradouro.length&&e.logradouro.val("");else if(void 0!==a.nome_bairro&&e.bairro.length&&e.bairro.val(a.nome_bairro),e.logradouro.length){var i;i="logradouro"===a.tipo?a.prefixo+" "+a.nome:a.endereco+" - "+a.nome,e.logradouro.val(i)}},configureUFCidade:function(e){e.cidadeActual=e.cidades.val(),e.initialCidade=e.cidades.data("initial-value"),e.initialCidade&&(e.cidadeActual=e.initialCidade),e.cidadesWrapper=e.cidades.parents(".linha-field").first(),"0"!==e.estados.val()&&""!==e.estados.val()&&PikiCEP.changeEstado(e),e.estados.on("change.PikiCEP",function(){e.estados.data("load-onchange")&&PikiCEP.changeEstado(e)}),e.estados.on("forceChange",function(){PikiCEP.changeEstado(e)})},changeEstado:function(e){PikiCEP.clearCidades(e),PikiCEP.getCidades(e)},clearCidades:function(e){e.cidades.find("option").first();PikiCEP.clearField(e.cidades),PikiCEP.disableField(e.cidades)},enableField:function(e){e.prop("disabled",!1).trigger("actualize")},disableField:function(e){e.prop("disabled",!0).trigger("actualize")},clearField:function(e){e.children("option").first().siblings().remove(),e.trigger("actualize")},getCidades:function(a){if("0"==a.estados.val())return PikiCEP.clearCidades(a),PikiCEP.enableField(a.estados),void PikiCEP.disableField(a.cidades);e.ajax({type:"POST",url:Piki.ajaxurl+"?estado="+a.estados.val(),dataType:"JSON",data:{action:"piki_field_ajax",field_type:"ufcidade",field_action:"ajax_get_cidades",estado:a.estados.val()},beforeSend:function(e){a.cidadesWrapper.addClass("loading"),e.overrideMimeType("text/plain; charset=utf-8")}}).done(function(e){PikiCEP.pululateCidades(a,e),a.cidadesWrapper.removeClass("loading")}).error(function(){a.cidadesWrapper.removeClass("loading")})},pululateCidades:function(a,i){if(PikiCEP.clearField(a.cidades),e.each(i,function(e,i){a.cidades.append('<option value="'+e+'">'+i+"</option>")}),a.cidadeActual){a.cidades.children('[value="'+a.cidadeActual+'"]').length&&a.cidades.val(a.cidadeActual)}PikiCEP.enableField(a.cidades)}}).main()}(jQuery);