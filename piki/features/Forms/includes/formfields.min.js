!function($){$(function(){$("div.PikiField").PikiField()}),$.fn.PikiField=function(method){var args=arguments;return this.each(function(){var field=this,$field=$(this);this.init=function(){this.post_id=$field.parents("form").first().find("input#post_ID").first().val();var e=$.extend({},{target:!1},e);this.fields=$(".wrapp-fields",$field).first(),this.new_ftype=$("select.pikifield-new-ftype",$field).first(),this.new_name=$("input.pikifield-new-name",$field).first(),this.new_machine_name=$("input.pikifield-new-machine-name",$field).first(),this.new_machine_name.on("keypress",function(e){if(8==e.keyCode||e.keyCode>=37&&e.keyCode<=40)return!0;var i=new RegExp("^[a-zA-Z0-9_]+$"),t=String.fromCharCode(e.charCode?e.charCode:e.which);return!!i.test(t)||(e.preventDefault(),!1)}),this.new_machine_name.on("keyup",function(){var e=new RegExp("[^a-zA-Z0-9_]","g"),i=$(this);e.test(i.val())&&i.val(i.val().replace(e,""))}),this.new_submit=$("input.pikifield-new-ok",$field).first(),this.new_submit.click(function(){field.addField($(this))}),this.new_fieldset=$("select.pikifield-new-fieldset",$field).first(),1==this.new_fieldset.children("option").length&&this.new_fieldset.parents(".linha-field").first().hide(),this.new_fieldset.change(function(){var e=$(this).val();""!=e&&(field.closeField(field.fields.children(".fieldset-options")),field.openField(field.fields.children('.fieldset-options[rel="'+e+'"]')))});var i={axis:"y",handle:"> .header > h3",placeholder:"ui-state-highlight",start:function(e,i){i.placeholder.css("height",i.item.outerHeight()-2)}};this.fields.sortable(i),this.fields.find(".fieldset-fields").sortable(i),this.initCloseFields(),this.fields.on("mouseup","h3",function(){var e=$(this).parents(".fieldset-options, .field-options").first();field.toogleField(e)}),this.fields.on("click",".remove-button",function(e){e.preventDefault();var i=$(this).parents(".fieldset-options, .field-options").first();field.removeField(i)}),this.fields.on("keydown","input.label",function(e){var i=$(this);i.data("before_value")||i.data("before_value",i.val())}),this.fields.on("keyup","input.label",function(e){$_field=$(this);var i=""==$_field.val()?"Nome do campo":$_field.val();$_field.parents(".fieldset-options, .field-options").first().find(" > .header .nome").html(i)}),this.fields.on("blur","input.label",function(e){if($_field=$(this),$_field.val().length<2)return alert("O nome do campo deve ter pelo menos dois caracteres"),void $_field.val($_field.data("before_value"))})},this.initCloseFields=function(){var e=$.cookie("PikiField_parent_"+this.post_id),i=$.cookie("PikiField_child_"+this.post_id);this.fields.children(".fieldset-options,.field-options").each(function(t){var n=$(this);e!=t&&field.closeField(n),n.is(".fieldset-options")&&n.find(".field-options").each(function(n){var l=$(this);e==t&&l.index()==i||field.closeField(l)})})},this.toogleField=function(e){e.is(".closed")?(field.openField(e),field.closeSiblings(e)):field.closeField(e),this.setCookie(e)},this.removeField=function(e){e.fadeOut(300),e.delay(310).remove()},this.setCookie=function(e){var i="PikiField_"+(e.parent().is(".wrapp-fields")?"parent":"child")+"_"+e.parents("form").first().find("input#post_ID").first().val(),t=e.is(".closed")?"x":e.index();$.cookie(i,t)},this.reorganizeFields=function(e){var i="";e.is(".fieldset-options")&&(i+=".footer ");var t=e.find(i+"input.machine_name").val();if(""!=t){var n=e.parent().is(".fieldset-fields")?2:1;e.find("input,select,textarea").each(function(){var e=$(this),i=e.attr("name").split("["),l=i.shift();2==n&&(l+="["+i.shift()),i.shift();var s=l+"["+t+"]["+i.join("[");e.attr("name",s);var a=s.split("][").join("_").replace("[","_").replace("]","");e.attr("id",a)})}else alert("Problemas com o nome do campo.")},this.closeField=function(e){var i=e.children(".header");e.css("height",i.outerHeight()-1).addClass("closed")},this.openField=function(e){e.css("height","auto").removeClass("closed")},this.closeSiblings=function(e){e.siblings().each(function(){field.closeField($(this))})},this.actualizeFieldsets=function(){var e="";this.fields.children(".fieldset-options").each(function(){var i=$(this),t=i.find(".footer input.machine_name");""!=t.val()&&(i.attr("rel",t.val()),e+='<option value="'+t.val()+'">no grupo '+i.find(".footer input.label").val()+"</option>")});var i=this.new_fieldset.find("option").first();this.new_fieldset.html(i),""!=e&&(this.new_fieldset.append(e),this.new_fieldset.parents(".linha-field").first().show())},this.addField=function(){var e=$field.find('input.machine_name[value="'+this.new_machine_name.val()+'"]').length;if(""==this.new_name.val())return alert("Informe o nome do campo que deseja criar"),!1;if(""==this.new_machine_name.val())return alert("Informe o ID único do campo que deseja criar"),!1;if(e)return alert("O ID único informado já existe no formulário"),!1;if(this.new_machine_name.val().length<3)return alert("O ID único do campo deve ter no míniomo 3 caracteres"),!1;if(0==this.new_ftype.val())return alert("Selecione um tipo de campo"),!1;var i={action:"formfields_get_row",ftype:this.new_ftype.val(),name:this.new_name.val(),machine_name:this.new_machine_name.val()};"0"!=this.new_fieldset.val()&&(i.parent_field=this.new_fieldset.val()),$.fn.pikiLoader(),$.ajax({type:"POST",data:i,url:Piki.ajaxurl,dataType:"JSON"}).done(function(e){if($.fn.pikiLoader("close"),"success"==e.status){field.resetAddForm();var i=$(e.field);if(e.parent&&e.parent.length>1){var t=field.fields.children('.fieldset-options[rel="'+e.parent[0]+'"]');i.appendTo(t.find(".fieldset-fields"))}else field.fields.append(i);field.closeSiblings(i),"fieldset"==e.ftype&&(i.find(".fieldset-content .fieldset-fields").sortable(),field.actualizeFieldsets())}})},this.resetAddForm=function(){this.new_name.val(""),this.new_ftype.val("")};var toCall;if(void 0==(toCall=eval("this."+method))){if(void 0==!this.ready)return;this.init.apply(this,args)}else toCall.apply(this,Array.prototype.slice.call(args,1))})}}(jQuery);